# Руководство по работе с webhook для Telegram бота

В этом документе описаны инструкции по настройке, мониторингу и устранению неполадок webhook для Telegram бота.

## Что такое webhook?

Webhook - это механизм, позволяющий Telegram отправлять обновления (сообщения, команды и т.д.) на ваш сервер сразу после их появления, вместо того, чтобы ваш бот постоянно опрашивал сервер Telegram.

Преимущества webhook по сравнению с long polling:
- Мгновенная обработка обновлений
- Меньшая нагрузка на сервер
- Более стабильная работа на Replit

## Настройка webhook

### Автоматическая настройка

Webhook автоматически настраивается при запуске бота, если установлена переменная окружения `USE_WEBHOOK=true`. Это происходит в файле `main.py`.

### Ручная настройка

Для ручной настройки webhook используйте скрипт `check_webhook.py`:

```bash
# Проверка текущих настроек webhook
python check_webhook.py check

# Установка webhook на URL Replit
python check_webhook.py set

# Установка webhook на произвольный URL
python check_webhook.py set https://yourdomain.com/webhook/TOKEN

# Удаление webhook (переход на long polling)
python check_webhook.py delete
```

## Мониторинг webhook

### Проверка работоспособности webhook

Для проверки работоспособности webhook используйте:

```bash
python check_webhook.py check
```

Этот скрипт покажет:
- Текущий URL webhook
- Количество ожидающих обновлений
- Последнюю ошибку (если есть)
- Статус webhook

### Скрипт проверки статуса бота

Для полной проверки статуса бота используйте:

```bash
./check_bot_status.sh
```

Этот скрипт выполняет:
- Проверку настроек webhook через Telegram API
- Проверку доступности health-endpoint
- Вывод списка запущенных процессов бота
- Вывод последних строк из лога keepalive

### Health endpoint

Бот имеет health endpoint, доступный по адресу:

```
https://[replit-domain]/webhook/health
```

Этот endpoint возвращает информацию о состоянии бота в формате JSON.

### Тестирование webhook с тестовыми данными

Для тестирования webhook с тестовыми данными используйте скрипт `test_webhook.py`:

```bash
python test_webhook.py
```

## Устранение неполадок webhook

### Частые ошибки и их решения

1. **"Webhook was not set"**
   - Проверьте, правильно ли указан URL webhook
   - Убедитесь, что URL доступен извне

2. **"Wrong response from the webhook: 500 Internal Server Error"**
   - Проверьте логи Flask-приложения
   - Убедитесь, что код обработки webhook не содержит ошибок

3. **"Bad gateway" или "Connection error"**
   - Проверьте, запущен ли ваш сервер
   - Проверьте, доступен ли Replit извне

### Рестарт бота и webhook

Для полного рестарта бота и webhook используйте:

```bash
./start_production.sh
```

Этот скрипт:
1. Останавливает все процессы бота
2. Запускает Flask-приложение
3. Запускает бота с поддержкой webhook
4. Проверяет статус бота

## Скрипты для автоматического поддержания работы

### keepalive.sh

Скрипт `keepalive.sh` запускается в фоне и периодически пингует health endpoint для предотвращения "засыпания" Replit без Reserved VM.

### run_forever.sh

Скрипт `run_forever.sh` автоматически перезапускает бота при его аварийном завершении.

## Рекомендации по использованию webhook

1. Используйте Reserved VM на Replit для стабильной работы
2. Обрабатывайте все обновления быстро (не более 60 секунд)
3. Всегда возвращайте статус-код 200 из webhook-обработчика, даже при ошибках
4. Регулярно проверяйте статус webhook с помощью скриптов мониторинга

## Дополнительная информация

Подробную информацию о webhook API Telegram можно найти в [официальной документации](https://core.telegram.org/bots/api#setwebhook).