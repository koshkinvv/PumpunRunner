# Инструкция по настройке и поддержке webhook для Telegram бота

## Введение

Этот документ описывает процесс настройки, поддержки и мониторинга webhook для Telegram бота. Webhook позволяет боту получать обновления от Telegram API напрямую через HTTP-запросы, что особенно важно для стабильной работы в Replit.

## Компоненты системы

1. **Flask-приложение** - обрабатывает входящие webhook-запросы от Telegram API и управляет веб-интерфейсом для мониторинга.
2. **Telegram Bot** - основная логика бота, реализованная с помощью python-telegram-bot.
3. **Keepalive скрипт** - предотвращает "засыпание" Replit путём регулярных проверок health-endpoint.
4. **Мониторинг и автоперезапуск** - система мониторинга и автоматического перезапуска компонентов при сбоях.

## Скрипты и их назначение

### Запуск и управление

- `run_forever.sh` - основной скрипт для запуска всей системы с автоматическим перезапуском компонентов при сбоях.
- `start_production.sh` - запускает все компоненты системы в производственном режиме.
- `keepalive.sh` - предотвращает "засыпание" Replit, отправляя запросы к health-endpoint.
- `start_keepalive.sh` - запускает keepalive скрипт в фоновом режиме.
- `refresh_webhook.sh` - обновляет настройки webhook в Telegram API.
- `check_bot_status.sh` - проверяет текущий статус бота и webhook.

### Файлы для работы webhook

- `webhook_server.py` - реализует обработку webhook-запросов от Telegram API.
- `app.py` - основное Flask-приложение, которое интегрирует webhook и веб-интерфейс.

## Инструкция по запуску

### Постоянная работа (рекомендуется)

Этот метод обеспечивает автоматический перезапуск компонентов при сбоях:

```bash
./run_forever.sh
```

### Стандартный запуск

```bash
./start_production.sh
```

## Проверка статуса и мониторинг

### Проверка текущего статуса

```bash
./check_bot_status.sh
```

### Мониторинг через веб-интерфейс

Откройте веб-интерфейс по адресу: `https://{ваш_домен_replit}/`

## Диагностика проблем

### Проверка настроек webhook

```bash
python check_webhook.py
```

### Проверка логов

```bash
tail -f logs/keepalive.log
tail -f logs/bot_*.log
```

## Решение распространенных проблем

### Webhook не получает обновления

1. Проверьте, что URL webhook правильно настроен в Telegram API:
   ```bash
   ./check_bot_status.sh
   ```
2. Убедитесь, что Flask-приложение работает и доступно:
   ```bash
   curl https://{ваш_домен_replit}/webhook/health
   ```
3. Обновите настройки webhook:
   ```bash
   ./refresh_webhook.sh
   ```

### Бот перестал отвечать

1. Перезапустите всю систему:
   ```bash
   ./run_forever.sh
   ```

### Replit "засыпает"

1. Убедитесь, что keepalive скрипт работает:
   ```bash
   ps aux | grep keepalive
   ```
2. Перезапустите keepalive:
   ```bash
   ./start_keepalive.sh
   ```

## Рекомендации

1. Используйте Replit Reserved VM для гарантированной стабильной работы бота.
2. Регулярно проверяйте статус webhook с помощью `check_bot_status.sh`.
3. Настройте мониторинг для получения уведомлений о проблемах.