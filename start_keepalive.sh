#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ keepalive –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç keepalive.sh —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ ! -f "keepalive.sh" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª keepalive.sh –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

# –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
chmod +x keepalive.sh

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ —É–∂–µ —Å–∫—Ä–∏–ø—Ç keepalive
if pgrep -f "bash.*keepalive.sh" > /dev/null; then
    echo "‚ö†Ô∏è –°–∫—Ä–∏–ø—Ç keepalive.sh —É–∂–µ –∑–∞–ø—É—â–µ–Ω"
    echo "–ü—Ä–æ—Ü–µ—Å—Å—ã keepalive:"
    ps aux | grep "bash.*keepalive.sh" | grep -v grep
    echo ""
    echo "–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç, —Å–Ω–∞—á–∞–ª–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ:"
    echo "pkill -f 'bash.*keepalive.sh'"
    exit 0
fi

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
mkdir -p logs

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ —Å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –≤—ã–≤–æ–¥–∞ –≤ –ª–æ–≥-—Ñ–∞–π–ª
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º keepalive.sh –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ..."
nohup ./keepalive.sh > logs/keepalive.log 2>&1 &

# –°–æ—Ö—Ä–∞–Ω—è–µ–º PID –ø—Ä–æ—Ü–µ—Å—Å–∞
KEEPALIVE_PID=$!
echo "‚úÖ –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω —Å PID: $KEEPALIVE_PID"
echo "–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ–≥–æ —Å—Ç–∞—Ç—É—Å –∫–æ–º–∞–Ω–¥–æ–π:"
echo "ps aux | grep keepalive"
echo ""
echo "–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:"
echo "tail -f logs/keepalive.log"
echo ""
echo "–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:"
echo "pkill -f 'bash.*keepalive.sh'"