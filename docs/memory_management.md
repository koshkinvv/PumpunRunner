# Управление памятью в Telegram боте

## Обзор проблемы

Telegram бот может потреблять значительное количество памяти по следующим причинам:

1. **Запуск нескольких экземпляров бота** - Когда несколько экземпляров бота запущены одновременно, они дублируют использование памяти.
2. **Утечки памяти** - Некоторые компоненты могут не освобождать память после использования.
3. **Кэширование данных** - Неоптимизированное кэширование может привести к чрезмерному использованию памяти.
4. **Длительное выполнение** - Бот, работающий без перезапуска в течение долгого времени, может накапливать неиспользуемые объекты.

## Решения

### 1. Предотвращение запуска нескольких экземпляров

В файле `run_telegram_bot.py` реализована система блокировки, которая:

- Проверяет наличие других запущенных экземпляров бота
- Завершает все найденные дополнительные экземпляры
- Использует блокировку файла для предотвращения одновременного запуска нескольких экземпляров

### 2. Мониторинг использования памяти

В скрипт добавлена функция мониторинга использования памяти, которая:

- Периодически проверяет объем памяти, используемой процессом
- Логирует увеличение использования памяти
- Предупреждает о значительном росте использования памяти
- Рекомендует перезапуск при критическом росте

### 3. Управление логами

Для предотвращения заполнения диска файлами логов:

- Реализовано ограничение количества хранимых файлов логов
- Автоматическое удаление старых файлов логов
- Хранятся только 10 последних файлов логов

### 4. Периодический перезапуск

Для долгосрочной стабильности рекомендуется:

- Настроить периодический плановый перезапуск бота (например, через cron)
- Перезапускать бот каждые 24 часа для очистки памяти
- Использовать скрипт `maintenance.sh` для проверки состояния и перезапуска при необходимости

## Использование

Для использования оптимизированного управления памятью:

1. Запускайте бота через скрипт `run_telegram_bot.py`
2. Регулярно проверяйте логи для мониторинга использования памяти
3. Настройте периодический запуск скрипта `maintenance.sh` для обслуживания

## Дополнительные рекомендации

- Используйте Reserved VM в Replit для стабильной работы
- Периодически проверяйте статус бота через веб-интерфейс
- При обнаружении критического использования памяти перезапустите бота