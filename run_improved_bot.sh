#!/bin/bash

# Скрипт для запуска бота с улучшенным форматированием тренировок
# Этот скрипт обеспечивает выполнение следующих операций:
# 1. Проверяет, не запущен ли уже бот
# 2. Останавливает бота, если он запущен
# 3. Сбрасывает сессию Telegram API
# 4. Запускает бота с использованием улучшенной функции форматирования тренировок

# Настройка логирования
LOG_FILE="bot_improved.log"
echo "[$(date)] Запуск бота с улучшенным форматированием тренировок" >> $LOG_FILE

# Проверка, запущен ли бот
if [ -f "bot.pid" ]; then
    PID=$(cat bot.pid)
    if ps -p $PID > /dev/null; then
        echo "[$(date)] Останавливаю существующий процесс бота (PID: $PID)" >> $LOG_FILE
        kill -9 $PID 2>/dev/null
        sleep 1
    fi
    rm bot.pid 2>/dev/null
fi

# Завершаем все процессы Python, связанные с ботом
echo "[$(date)] Завершаем все процессы Python, связанные с ботом" >> $LOG_FILE
pkill -f "python.*bot.*py" 2>/dev/null
sleep 1

# Сброс сессии Telegram API
echo "[$(date)] Сбрасываем сессию Telegram API" >> $LOG_FILE
# Опционально можно добавить API-запрос для удаления webhook и сброса обновлений

# Запуск бота с улучшенным форматированием
echo "[$(date)] Запускаем бота с улучшенным форматированием тренировок" >> $LOG_FILE
nohup python start_improved_bot.py >> $LOG_FILE 2>&1 &

echo "[$(date)] Бот запущен и работает в фоновом режиме" >> $LOG_FILE
echo "Бот запущен. Логи доступны в файле $LOG_FILE"

# Создаем файл для мониторинга здоровья бота
echo $(date +%s) > bot_health.txt