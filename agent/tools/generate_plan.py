#!/usr/bin/env python3
"""
MCP-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª—è –±–µ–≥—É–Ω–∞.
–°–æ–≤–º–µ—Å—Ç–∏–º —Å OpenAI Agents SDK –∏ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ, —Ç–∞–∫ –∏ 
–≤ —Å–æ—Å—Ç–∞–≤–µ –∞–≥–µ–Ω—Ç–∞.

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è –∏–∑ –∫–Ω–∏–≥:
- "Training Distance Runners" (Jack Daniels)
- "Science of Running" (Steve Magness)
- "Periodization Training for Sports" (Tudor Bompa)
"""

import os
import json
from datetime import datetime
from typing import List, Optional
from pydantic import BaseModel
from openai import OpenAI

# the newest OpenAI model is "gpt-4o" which was released May 13, 2024.
# do not change this unless explicitly requested by the user
MODEL = "gpt-4o"


class RecentRun(BaseModel):
    """–ú–æ–¥–µ–ª—å –¥–ª—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –Ω–µ–¥–∞–≤–Ω–∏—Ö –ø—Ä–æ–±–µ–∂–µ–∫"""
    date: str
    distance: float
    pace: str


class RunnerProfile(BaseModel):
    """–ú–æ–¥–µ–ª—å –¥–ª—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –±–µ–≥—É–Ω–∞"""
    age: int
    gender: str
    weight: float
    height: float
    level: str  # beginner / amateur / advanced
    weekly_distance: float
    goal_distance: str
    goal_date: str
    available_days: List[str]
    recent_runs: Optional[List[RecentRun]] = []


class GeneratePlanUseCase:
    """
    MCP-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤.
    –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º Model Context Protocol –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    –≤ OpenAI Agents SDK.
    """
    id = "generate_training_plan"
    description = "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è 7-–¥–Ω–µ–≤–Ω–æ–≥–æ –±–µ–≥–æ–≤–æ–≥–æ –ø–ª–∞–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
    input_model = RunnerProfile
    output_model = str

    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ —Å OpenAI –∫–ª–∏–µ–Ω—Ç–æ–º"""
        api_key = os.environ.get("OPENAI_API_KEY")
        if not api_key:
            raise ValueError("OPENAI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
        self.client = OpenAI(api_key=api_key)

    def __call__(self, input: RunnerProfile) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–π –ø–ª–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª—è –±–µ–≥—É–Ω–∞.
        
        Args:
            input: –ü—Ä–æ—Ñ–∏–ª—å –±–µ–≥—É–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ RunnerProfile
            
        Returns:
            str: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ markdown-—Ñ–æ—Ä–º–∞—Ç–µ
        """
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç—ã
        system_prompt = self._create_system_prompt()
        user_prompt = self._create_user_prompt(input)
        
        # –í—ã–∑—ã–≤–∞–µ–º OpenAI API
        try:
            response = self.client.chat.completions.create(
                model=MODEL,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_prompt}
                ],
                response_format={"type": "json_object"},
                temperature=0.7
            )
            
            # –ü–æ–ª—É—á–∞–µ–º –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            content = response.choices[0].message.content
            plan_data = json.loads(content)
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø–ª–∞–Ω –≤ markdown
            formatted_plan = self._format_training_plan(plan_data)
            return formatted_plan
            
        except Exception as e:
            return f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞–Ω–∞: {str(e)}"

    def _create_system_prompt(self) -> str:
        """
        –°–æ–∑–¥–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–π –∏–∑ –∫–Ω–∏–≥
        Jack Daniels, Steve Magness, Tudor Bompa.
        
        Returns:
            str: –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è OpenAI
        """
        return """–¢—ã –æ–ø—ã—Ç–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä –ø–æ –±–µ–≥—É, —ç–∫—Å–ø–µ—Ä—Ç —Å –≥–ª—É–±–æ–∫–∏–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏ –ø–µ—Ä–µ–¥–æ–≤—ã—Ö –º–µ—Ç–æ–¥–∏–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫, 
–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞ –ª—É—á—à–∏—Ö –∫–Ω–∏–≥–∞—Ö –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è—Ö:

‚Ä¢ Jack Daniels ("Training Distance Runners") - —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–ª —Ñ–æ—Ä–º—É–ª—ã —Ä–∞—Å—á–µ—Ç–∞ VDOT –∏ –Ω–∞–≥—Ä—É–∑–∫–∏, –æ–ø—Ä–µ–¥–µ–ª–∏–ª –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –ø—É–ª—å—Å–æ–≤—ã–µ –∑–æ–Ω—ã
‚Ä¢ Steve Magness ("Science of Running") - –∏—Å—Å–ª–µ–¥–æ–≤–∞–ª —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—é –±–µ–≥–∞ –∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—é –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –Ω–∞ –Ω–∞—É—á–Ω–æ–π –æ—Å–Ω–æ–≤–µ
‚Ä¢ Tudor Bompa ("Periodization Training for Sports") - —Å–æ–∑–¥–∞–ª –ø—Ä–∏–Ω—Ü–∏–ø—ã –ø–µ—Ä–∏–æ–¥–∏–∑–∞—Ü–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–∏–∫–∞ —Ñ–æ—Ä–º—ã –∫ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è–º
‚Ä¢ Brad Stulberg & Steve Magness ("Peak Performance") - —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–ª–∏ –º–µ—Ç–æ–¥–∏–∫–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–∏–∫–æ–≤—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π —Å —É—á–µ—Ç–æ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
‚Ä¢ David Joyce & Daniel Lewindon ("High-Performance Training for Sports") - —Å–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–ª–∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏

–ü—Ä–∏ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤ —Ç—ã:

1) –¢—â–∞—Ç–µ–ª—å–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –ø—Ä–æ—Ñ–∏–ª—å –±–µ–≥—É–Ω–∞:
   - –§–∏–∑–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–ø–æ–ª, –≤–æ–∑—Ä–∞—Å—Ç, –≤–µ—Å, —Ä–æ—Å—Ç) –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –Ω–∞–≥—Ä—É–∑–æ–∫
   - –¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∏ –æ–ø—ã—Ç –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
   - –¶–µ–ª–µ–≤—É—é –¥–∏—Å—Ç–∞–Ω—Ü–∏—é –∏ –¥–∞—Ç—É —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø–µ—Ä–∏–æ–¥–∏–∑–∞—Ü–∏–∏
   - –ö–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π —Ç–µ–º–ø –∏ –Ω–µ–¥–µ–ª—å–Ω—ã–π –æ–±—ä–µ–º –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
   - –ù–µ–¥–∞–≤–Ω–∏–µ –ø—Ä–æ–±–µ–∂–∫–∏ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Ñ–æ—Ä–º—ã

2) –°–æ–∑–¥–∞–µ—à—å –Ω–∞—É—á–Ω–æ-–æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ –ø–ª–∞–Ω—ã, –≤–∫–ª—é—á–∞—è:
   - –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ —Å —Å–æ–±–ª—é–¥–µ–Ω–∏–µ–º –ø—Ä–∏–Ω—Ü–∏–ø–∞ —Å—É–ø–µ—Ä–∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏
   - –ß–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–æ–≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ —Ä–∞–∑–Ω–æ–π –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ (80:20 –ø—Ä–∞–≤–∏–ª–æ)
   - –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫: –¥–ª–∏—Ç–µ–ª—å–Ω—ã–µ –∞—ç—Ä–æ–±–Ω—ã–µ, —Ç–µ–º–ø–æ–≤—ã–µ, –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω—ã–µ, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ–ª—å–Ω—ã–µ
   - –ê–¥–∞–ø—Ç–∞—Ü–∏—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∫ —É—Ä–æ–≤–Ω—é –±–µ–≥—É–Ω–∞ —Å –¥–æ–ø—É—Å—Ç–∏–º—ã–º —Ç–µ–º–ø–æ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ 5-10% –≤ –Ω–µ–¥–µ–ª—é
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º—É–ª –î–∂–µ–∫–∞ –î—ç–Ω–∏–µ–ª—Å–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö –∑–æ–Ω –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏

3) –î–∞–µ—à—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ:
   - –¢–µ–º–ø–∞–º –±–µ–≥–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ (—Å —É—á–µ—Ç–æ–º —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∑–æ–Ω)
   - –¢–µ—Ö–Ω–∏–∫–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –∏ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–µ —Ç—Ä–∞–≤–º
   - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é –º–µ–∂–¥—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏, –≤–∫–ª—é—á–∞—è —Å–æ–Ω –∏ –ø–∏—Ç–∞–Ω–∏–µ
   - –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–µ –ø–ª–∞–Ω–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è—Ö –æ—Ç –≥—Ä–∞—Ñ–∏–∫–∞
   - –ú–µ–Ω—Ç–∞–ª—å–Ω–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –∫ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è–º

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç –±–µ–≥—É–Ω—É –¥–æ—Å—Ç–∏—á—å —Ü–µ–ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ, —Å —É—á–µ—Ç–æ–º –Ω–∞—É—á–Ω—ã—Ö –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞ —Ç—Ä–µ–Ω–µ—Ä—Å–∫–æ–π —Ä–∞–±–æ—Ç—ã."""

    def _create_user_prompt(self, profile: RunnerProfile) -> str:
        """
        –°–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª—è –±–µ–≥—É–Ω–∞.
        
        Args:
            profile: –ü—Ä–æ—Ñ–∏–ª—å –±–µ–≥—É–Ω–∞
            
        Returns:
            str: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç –¥–ª—è OpenAI
        """
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —É—Ä–æ–≤–µ–Ω—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –≤ —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        level_map = {
            "beginner": "–ù–∞—á–∏–Ω–∞—é—â–∏–π",
            "amateur": "–õ—é–±–∏—Ç–µ–ª—å",
            "advanced": "–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π"
        }
        level_ru = level_map.get(profile.level, profile.level)
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–µ–¥–∞–≤–Ω–∏–µ –ø—Ä–æ–±–µ–∂–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        recent_runs_text = ""
        if profile.recent_runs:
            recent_runs_text = "–ù–µ–¥–∞–≤–Ω–∏–µ –ø—Ä–æ–±–µ–∂–∫–∏:\n"
            for run in profile.recent_runs:
                recent_runs_text += f"- {run.date}: {run.distance} –∫–º, —Ç–µ–º–ø {run.pace} –º–∏–Ω/–∫–º\n"
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
        available_days_text = ", ".join(profile.available_days)
        
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç
        prompt = f"""–°–æ—Å—Ç–∞–≤—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω –±–µ–≥–æ–≤—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –Ω–∞ 7 –¥–Ω–µ–π –¥–ª—è –±–µ–≥—É–Ω–∞ —Å–æ —Å–ª–µ–¥—É—é—â–∏–º –ø—Ä–æ—Ñ–∏–ª–µ–º:

–ü–æ–ª: {profile.gender}
–í–æ–∑—Ä–∞—Å—Ç: {profile.age}
–†–æ—Å—Ç: {profile.height} —Å–º
–í–µ—Å: {profile.weight} –∫–≥
–£—Ä–æ–≤–µ–Ω—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏: {level_ru}
–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ–±—ä–µ–º –±–µ–≥–∞: {profile.weekly_distance} –∫–º
–¶–µ–ª–µ–≤–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è: {profile.goal_distance}
–î–∞—Ç–∞ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è: {profile.goal_date}
–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–Ω–∏ –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫: {available_days_text}
{recent_runs_text}

–ü–ª–∞–Ω –¥–æ–ª–∂–µ–Ω –≤–∫–ª—é—á–∞—Ç—å:
1. –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏ —Å —É—á–µ—Ç–æ–º –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–Ω–µ–π
2. –î–∏—Å—Ç–∞–Ω—Ü–∏—é –∏ —Ü–µ–ª–µ–≤–æ–π —Ç–µ–º–ø –¥–ª—è –∫–∞–∂–¥–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
3. –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø—É–ª—å—Å–æ–≤–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω 
4. –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å —Ç–∞–∫—Ç–∏–∫–æ–π
5. –û–±—â–∏–π –Ω–µ–¥–µ–ª—å–Ω—ã–π –æ–±—ä–µ–º –∏ –µ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–æ–ª—è–º–∏:
- "plan_name": –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∞
- "plan_description": –æ–ø–∏—Å–∞–Ω–∏–µ —Ü–µ–ª–∏ –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π –ø–ª–∞–Ω–∞
- "weekly_volume": –æ–±—â–∏–π –æ–±—ä–µ–º –∑–∞ –Ω–µ–¥–µ–ª—é –≤ –∫–º (—á–∏—Å–ª–æ)
- "intensity_distribution": —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
- "training_days": –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏, –≤–∫–ª—é—á–∞—é—â–∏–π:
  * "day": –Ω–æ–º–µ—Ä –¥–Ω—è (1-7)
  * "day_of_week": –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
  * "date": –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î
  * "workout_type": —Ç–∏–ø —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
  * "distance": –¥–∏—Å—Ç–∞–Ω—Ü–∏—è –≤ –∫–º (—á–∏—Å–ª–æ)
  * "pace": —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ç–µ–º–ø –≤ –º–∏–Ω/–∫–º
  * "heart_rate": –¥–∏–∞–ø–∞–∑–æ–Ω –ø—É–ª—å—Å–∞
  * "description": –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
  * "purpose": —Ü–µ–ª—å —ç—Ç–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
- "rest_days": –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –¥–Ω—è–º–∏ –æ—Ç–¥—ã—Ö–∞, –≤–∫–ª—é—á–∞—é—â–∏–π:
  * "day": –Ω–æ–º–µ—Ä –¥–Ω—è (1-7)
  * "day_of_week": –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
  * "date": –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î
  * "activity": —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ –¥–µ–Ω—å –æ—Ç–¥—ã—Ö–∞
  * "purpose": —Ü–µ–ª—å –æ—Ç–¥—ã—Ö–∞
- "recommendations": –æ–±—ä–µ–∫—Ç —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏:
  * "nutrition": –ø–∏—Ç–∞–Ω–∏–µ
  * "recovery": –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
  * "progression": —Ä–∞–∑–≤–∏—Ç–∏–µ –≤ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –Ω–µ–¥–µ–ª–∏
  * "adjustments": —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–µ –ø–ª–∞–Ω–∞

–ò—Å–ø–æ–ª—å–∑—É–π –º–µ—Ç–æ–¥–∏–∫–∏ –∏–∑ –∫–Ω–∏–≥ Jack Daniels "Training Distance Runners", Steve Magness "Science of Running" –∏ Tudor Bompa "Periodization Training for Sports" –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö –∑–æ–Ω –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ –∏ –Ω–∞–≥—Ä—É–∑–∫–∏."""
        
        return prompt

    def _format_training_plan(self, plan: dict) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ø–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ markdown —Ñ–æ—Ä–º–∞—Ç.
        
        Args:
            plan: –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–ª–∞–Ω–∞
            
        Returns:
            str: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω –≤ markdown
        """
        output = []
        output.append(f"# üèÉ {plan.get('plan_name', '–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫')}")
        output.append("")
        
        # –û–ø–∏—Å–∞–Ω–∏–µ –ø–ª–∞–Ω–∞
        output.append(f"## üìù –û–ø–∏—Å–∞–Ω–∏–µ")
        output.append(plan.get('plan_description', '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'))
        output.append("")
        
        # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        output.append(f"## üìä –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è")
        output.append(f"- **–û–±—â–∏–π –æ–±—ä–µ–º**: {plan.get('weekly_volume', '?')} –∫–º")
        output.append(f"- **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏**: {plan.get('intensity_distribution', '?')}")
        output.append("")
        
        # –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–µ –¥–Ω–∏
        output.append("## üèÉ‚Äç‚ôÇÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–µ –¥–Ω–∏")
        for day in plan.get('training_days', []):
            output.append(f"### –î–µ–Ω—å {day.get('day', '?')} - {day.get('day_of_week', '?')} ({day.get('date', '?')})")
            output.append(f"**–¢–∏–ø**: {day.get('workout_type', '–ù–µ —É–∫–∞–∑–∞–Ω')}")
            output.append(f"**–î–∏—Å—Ç–∞–Ω—Ü–∏—è**: {day.get('distance', '?')} –∫–º")
            output.append(f"**–¢–µ–º–ø**: {day.get('pace', '–ù–µ —É–∫–∞–∑–∞–Ω')}")
            output.append(f"**–ü—É–ª—å—Å**: {day.get('heart_rate', '–ù–µ —É–∫–∞–∑–∞–Ω')}")
            output.append("")
            output.append("**–û–ø–∏—Å–∞–Ω–∏–µ**:")
            output.append(day.get('description', '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'))
            output.append("")
            output.append(f"**–¶–µ–ª—å**: {day.get('purpose', '–ù–µ —É–∫–∞–∑–∞–Ω–∞')}")
            output.append("")
        
        # –î–Ω–∏ –æ—Ç–¥—ã—Ö–∞
        output.append("## üõå –î–Ω–∏ –æ—Ç–¥—ã—Ö–∞")
        for day in plan.get('rest_days', []):
            output.append(f"### –î–µ–Ω—å {day.get('day', '?')} - {day.get('day_of_week', '?')} ({day.get('date', '?')})")
            output.append(f"**–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å**: {day.get('activity', '–ü–æ–ª–Ω—ã–π –æ—Ç–¥—ã—Ö')}")
            output.append(f"**–¶–µ–ª—å**: {day.get('purpose', '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ')}")
            output.append("")
        
        # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        recommendations = plan.get('recommendations', {})
        if recommendations:
            output.append("## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏")
            
            if 'nutrition' in recommendations:
                output.append("### üçé –ü–∏—Ç–∞–Ω–∏–µ")
                output.append(recommendations['nutrition'])
                output.append("")
                
            if 'recovery' in recommendations:
                output.append("### üßò –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ")
                output.append(recommendations['recovery'])
                output.append("")
                
            if 'progression' in recommendations:
                output.append("### üìà –ü—Ä–æ–≥—Ä–µ—Å—Å–∏—è")
                output.append(recommendations['progression'])
                output.append("")
                
            if 'adjustments' in recommendations:
                output.append("### üîß –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏")
                output.append(recommendations['adjustments'])
                output.append("")
        
        # –î–∞—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        output.append(f"---")
        output.append(f"–ü–ª–∞–Ω —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: {datetime.now().strftime('%d.%m.%Y %H:%M')}")
        
        return "\n".join(output)


# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é:
if __name__ == "__main__":
    # –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
    generate_plan_tool = GeneratePlanUseCase()
    
    # –ü—Ä–∏–º–µ—Ä –ø—Ä–æ—Ñ–∏–ª—è –±–µ–≥—É–Ω–∞
    profile = RunnerProfile(
        age=35,
        gender="–ú—É–∂—Å–∫–æ–π",
        weight=75.0,
        height=180.0,
        level="amateur",
        weekly_distance=30.0,
        goal_distance="21 –∫–º",
        goal_date="2025-08-15",
        available_days=["–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–°—Ä–µ–¥–∞", "–ü—è—Ç–Ω–∏—Ü–∞", "–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"],
        recent_runs=[
            RecentRun(date="2025-05-05", distance=8.5, pace="5:45"),
            RecentRun(date="2025-05-08", distance=10.0, pace="5:50")
        ]
    )
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–ª–∞–Ω
    plan = generate_plan_tool(profile)
    
    # –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    print(plan)