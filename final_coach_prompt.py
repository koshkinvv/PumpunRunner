#!/usr/bin/env python3
"""
–§–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º OpenAI GPT-4o –º–æ–¥–µ–ª–∏. 

–í–∫–ª—é—á–∞–µ—Ç –∑–Ω–∞–Ω–∏—è –∏–∑ –≤–µ–¥—É—â–∏—Ö –∫–Ω–∏–≥ –ø–æ —Ç—Ä–µ–Ω–µ—Ä—Å–∫–æ–º—É –∏—Å–∫—É—Å—Å—Ç–≤—É –∏ –ª—ë–≥–∫–æ–π –∞—Ç–ª–µ—Ç–∏–∫–µ,
–∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ JSON, —É–ª—É—á—à–µ–Ω —Ñ–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞.
"""
import os
import sys
import json
import logging
from datetime import datetime, timedelta
from typing import Dict, Any, List

# the newest OpenAI model is "gpt-4o" which was released May 13, 2024.
# do not change this unless explicitly requested by the user
MODEL = "gpt-4o"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
os.makedirs('logs', exist_ok=True)
log_file = f'logs/coach_prompt_{datetime.now().strftime("%Y%m%d_%H%M%S")}.log'
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler(log_file),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger("coach_prompt")

try:
    from openai import OpenAI
    OPENAI_AVAILABLE = True
except ImportError:
    logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É OpenAI. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–µ: pip install openai")
    OPENAI_AVAILABLE = False

class CoachPrompt:
    """–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —É–ª—É—á—à–µ–Ω–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤ –ø–æ –±–µ–≥—É"""
    
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –ø—Ä–æ–º–ø—Ç–æ–≤"""
        if not OPENAI_AVAILABLE:
            raise ImportError("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ OpenAI –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞")
            
        api_key = os.environ.get("OPENAI_API_KEY")
        if not api_key:
            raise ValueError("OPENAI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
            
        self.client = OpenAI(api_key=api_key)
        logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç—Ä–µ–Ω–µ—Ä—Å–∫–∏—Ö –ø—Ä–æ–º–ø—Ç–æ–≤")
    
    def get_system_prompt(self) -> str:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –¥–ª—è –º–æ–¥–µ–ª–∏ OpenAI,
        –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ –∫–Ω–∏–≥–∞—Ö –ø–æ —Ç—Ä–µ–Ω–µ—Ä—Å—Ç–≤—É –∏ –±–µ–≥—É.
        
        –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏:
        - "Training Distance Runners" (Jack Daniels)
        - "Science of Running" (Steve Magness)
        - "Periodization Training for Sports" (Tudor Bompa)
        - "Peak Performance" (Brad Stulberg & Steve Magness)
        - "High-Performance Training for Sports" (David Joyce & Daniel Lewindon)
        
        Returns:
            str: –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –º–æ–¥–µ–ª–∏
        """
        return """–¢—ã –æ–ø—ã—Ç–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä –ø–æ –±–µ–≥—É, —ç–∫—Å–ø–µ—Ä—Ç —Å –≥–ª—É–±–æ–∫–∏–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏ –ø–µ—Ä–µ–¥–æ–≤—ã—Ö –º–µ—Ç–æ–¥–∏–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫, 
–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞ –ª—É—á—à–∏—Ö –∫–Ω–∏–≥–∞—Ö –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è—Ö:

‚Ä¢ Jack Daniels ("Training Distance Runners") - —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–ª —Ñ–æ—Ä–º—É–ª—ã —Ä–∞—Å—á–µ—Ç–∞ VDOT –∏ –Ω–∞–≥—Ä—É–∑–∫–∏, –æ–ø—Ä–µ–¥–µ–ª–∏–ª –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –ø—É–ª—å—Å–æ–≤—ã–µ –∑–æ–Ω—ã
‚Ä¢ Steve Magness ("Science of Running") - –∏—Å—Å–ª–µ–¥–æ–≤–∞–ª —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—é –±–µ–≥–∞ –∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—é –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –Ω–∞ –Ω–∞—É—á–Ω–æ–π –æ—Å–Ω–æ–≤–µ
‚Ä¢ Tudor Bompa ("Periodization Training for Sports") - —Å–æ–∑–¥–∞–ª –ø—Ä–∏–Ω—Ü–∏–ø—ã –ø–µ—Ä–∏–æ–¥–∏–∑–∞—Ü–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–∏–∫–∞ —Ñ–æ—Ä–º—ã –∫ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è–º
‚Ä¢ Brad Stulberg & Steve Magness ("Peak Performance") - —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–ª–∏ –º–µ—Ç–æ–¥–∏–∫–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–∏–∫–æ–≤—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π —Å —É—á–µ—Ç–æ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
‚Ä¢ David Joyce & Daniel Lewindon ("High-Performance Training for Sports") - —Å–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–ª–∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏

–ü—Ä–∏ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤ —Ç—ã:

1) –¢—â–∞—Ç–µ–ª—å–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –ø—Ä–æ—Ñ–∏–ª—å –±–µ–≥—É–Ω–∞:
   - –§–∏–∑–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–ø–æ–ª, –≤–æ–∑—Ä–∞—Å—Ç, –≤–µ—Å, —Ä–æ—Å—Ç) –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –Ω–∞–≥—Ä—É–∑–æ–∫
   - –¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∏ –æ–ø—ã—Ç –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
   - –¶–µ–ª–µ–≤—É—é –¥–∏—Å—Ç–∞–Ω—Ü–∏—é –∏ –¥–∞—Ç—É —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø–µ—Ä–∏–æ–¥–∏–∑–∞—Ü–∏–∏
   - –¶–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è –∏ —Ç–µ–º–ø –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã—Ö –∑–æ–Ω
   - –ö–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π —Ç–µ–º–ø –∏ –Ω–µ–¥–µ–ª—å–Ω—ã–π –æ–±—ä–µ–º –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è

2) –°–æ–∑–¥–∞–µ—à—å –Ω–∞—É—á–Ω–æ-–æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ –ø–ª–∞–Ω—ã, –≤–∫–ª—é—á–∞—è:
   - –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ —Å —Å–æ–±–ª—é–¥–µ–Ω–∏–µ–º –ø—Ä–∏–Ω—Ü–∏–ø–∞ —Å—É–ø–µ—Ä–∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏
   - –ß–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–æ–≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ —Ä–∞–∑–Ω–æ–π –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ (80:20 –ø—Ä–∞–≤–∏–ª–æ)
   - –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫: –¥–ª–∏—Ç–µ–ª—å–Ω—ã–µ –∞—ç—Ä–æ–±–Ω—ã–µ, —Ç–µ–º–ø–æ–≤—ã–µ, –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω—ã–µ, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ–ª—å–Ω—ã–µ
   - –ê–¥–∞–ø—Ç–∞—Ü–∏—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∫ —É—Ä–æ–≤–Ω—é –±–µ–≥—É–Ω–∞ —Å –¥–æ–ø—É—Å—Ç–∏–º—ã–º —Ç–µ–º–ø–æ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ 5-10% –≤ –Ω–µ–¥–µ–ª—é
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º—É–ª –î–∂–µ–∫–∞ –î—ç–Ω–∏–µ–ª—Å–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö –∑–æ–Ω –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏

3) –î–∞–µ—à—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ:
   - –¢–µ–º–ø–∞–º –±–µ–≥–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ (—Å —É—á–µ—Ç–æ–º —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∑–æ–Ω)
   - –¢–µ—Ö–Ω–∏–∫–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –∏ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–µ —Ç—Ä–∞–≤–º
   - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é –º–µ–∂–¥—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏, –≤–∫–ª—é—á–∞—è —Å–æ–Ω –∏ –ø–∏—Ç–∞–Ω–∏–µ
   - –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–µ –ø–ª–∞–Ω–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è—Ö –æ—Ç –≥—Ä–∞—Ñ–∏–∫–∞
   - –ú–µ–Ω—Ç–∞–ª—å–Ω–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –∫ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è–º

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç –±–µ–≥—É–Ω—É –¥–æ—Å—Ç–∏—á—å —Ü–µ–ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ, —Å —É—á–µ—Ç–æ–º –Ω–∞—É—á–Ω—ã—Ö –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞ —Ç—Ä–µ–Ω–µ—Ä—Å–∫–æ–π —Ä–∞–±–æ—Ç—ã."""
    
    def get_user_prompt(self, profile: Dict[str, Any]) -> str:
        """
        –°–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª—è –±–µ–≥—É–Ω–∞
        
        Args:
            profile: –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–æ—Ñ–∏–ª—è –±–µ–≥—É–Ω–∞
            
        Returns:
            str: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
        """
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç None
        distance = profile.get('distance', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
        competition_date = profile.get('competition_date', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
        gender = profile.get('gender', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
        age = str(profile.get('age', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'))
        height = str(profile.get('height', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'))
        weight = str(profile.get('weight', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'))
        experience = profile.get('experience', '–ù–∞—á–∏–Ω–∞—é—â–∏–π')
        goal = profile.get('goal', '–§–∏–Ω–∏—à–∏—Ä–æ–≤–∞—Ç—å')
        target_time = profile.get('target_time', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
        fitness_level = profile.get('fitness_level', '–°—Ä–µ–¥–Ω–∏–π')
        comfortable_pace = profile.get('comfortable_pace', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
        weekly_volume = profile.get('weekly_volume_text', str(profile.get('weekly_volume', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')))
        training_days = str(profile.get('training_days_per_week', '3'))
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å
        prompt = f"""–°–æ—Å—Ç–∞–≤—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω –±–µ–≥–æ–≤—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –Ω–∞ 7 –¥–Ω–µ–π –¥–ª—è –±–µ–≥—É–Ω–∞ —Å–æ —Å–ª–µ–¥—É—é—â–∏–º –ø—Ä–æ—Ñ–∏–ª–µ–º:

–¶–µ–ª–µ–≤–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è: {distance}
–î–∞—Ç–∞ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è: {competition_date}
–ü–æ–ª: {gender}
–í–æ–∑—Ä–∞—Å—Ç: {age}
–†–æ—Å—Ç: {height} —Å–º
–í–µ—Å: {weight} –∫–≥
–û–ø—ã—Ç –±–µ–≥–∞: {experience}
–¶–µ–ª—å: {goal}
–¶–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è: {target_time}
–£—Ä–æ–≤–µ–Ω—å —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏: {fitness_level}
–ö–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π —Ç–µ–º–ø –±–µ–≥–∞: {comfortable_pace} –º–∏–Ω/–∫–º
–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ–±—ä–µ–º –±–µ–≥–∞: {weekly_volume} –∫–º
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ –Ω–µ–¥–µ–ª—é: {training_days}

–ü–ª–∞–Ω –¥–æ–ª–∂–µ–Ω –≤–∫–ª—é—á–∞—Ç—å:
1. –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏ —Å –¥–∞—Ç–∞–º–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ (–Ω–∞—á–∏–Ω–∞—è —Å –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞)
2. –î–∏—Å—Ç–∞–Ω—Ü–∏—é –∏ —Ü–µ–ª–µ–≤–æ–π —Ç–µ–º–ø –¥–ª—è –∫–∞–∂–¥–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
3. –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø—É–ª—å—Å–æ–≤–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω 
4. –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å —Ç–∞–∫—Ç–∏–∫–æ–π
5. –û–±—â–∏–π –Ω–µ–¥–µ–ª—å–Ω—ã–π –æ–±—ä–µ–º –∏ –µ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–æ–ª—è–º–∏:
- "plan_name": –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∞
- "plan_description": –æ–ø–∏—Å–∞–Ω–∏–µ —Ü–µ–ª–∏ –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π –ø–ª–∞–Ω–∞
- "weekly_volume": –æ–±—â–∏–π –æ–±—ä–µ–º –∑–∞ –Ω–µ–¥–µ–ª—é –≤ –∫–º (—á–∏—Å–ª–æ)
- "intensity_distribution": —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
- "training_days": –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏, –≤–∫–ª—é—á–∞—é—â–∏–π:
  * "day": –Ω–æ–º–µ—Ä –¥–Ω—è (1-7)
  * "day_of_week": –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
  * "date": –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î
  * "workout_type": —Ç–∏–ø —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
  * "distance": –¥–∏—Å—Ç–∞–Ω—Ü–∏—è –≤ –∫–º (—á–∏—Å–ª–æ)
  * "pace": —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ç–µ–º–ø –≤ –º–∏–Ω/–∫–º
  * "heart_rate": –¥–∏–∞–ø–∞–∑–æ–Ω –ø—É–ª—å—Å–∞
  * "description": –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
  * "purpose": —Ü–µ–ª—å —ç—Ç–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
- "rest_days": –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –¥–Ω—è–º–∏ –æ—Ç–¥—ã—Ö–∞, –≤–∫–ª—é—á–∞—é—â–∏–π:
  * "day": –Ω–æ–º–µ—Ä –¥–Ω—è (1-7)
  * "day_of_week": –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
  * "date": –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î
  * "activity": —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ –¥–µ–Ω—å –æ—Ç–¥—ã—Ö–∞
  * "purpose": —Ü–µ–ª—å –æ—Ç–¥—ã—Ö–∞
- "recommendations": –æ–±—ä–µ–∫—Ç —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏:
  * "nutrition": –ø–∏—Ç–∞–Ω–∏–µ
  * "recovery": –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
  * "progression": —Ä–∞–∑–≤–∏—Ç–∏–µ –≤ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –Ω–µ–¥–µ–ª–∏
  * "adjustments": —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–µ –ø–ª–∞–Ω–∞

–ò—Å–ø–æ–ª—å–∑—É–π –º–µ—Ç–æ–¥–∏–∫–∏ –∏–∑ –∫–Ω–∏–≥ Jack Daniels "Training Distance Runners", Steve Magness "Science of Running" –∏ Tudor Bompa "Periodization Training for Sports" –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö –∑–æ–Ω –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ –∏ –Ω–∞–≥—Ä—É–∑–∫–∏."""
        
        return prompt
    
    def generate_training_plan(self, profile: Dict[str, Any]) -> Dict[str, Any]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
        
        Args:
            profile: –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–æ—Ñ–∏–ª—è –±–µ–≥—É–Ω–∞
            
        Returns:
            Dict: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
        """
        try:
            # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–º–ø—Ç—ã
            system_prompt = self.get_system_prompt()
            user_prompt = self.get_user_prompt(profile)
            
            logger.info("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ OpenAI –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫")
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ API
            response = self.client.chat.completions.create(
                model=MODEL,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_prompt}
                ],
                response_format={"type": "json_object"},
                temperature=0.7
            )
            
            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
            content = response.choices[0].message.content
            logger.info("–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç OpenAI API")
            
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ JSON
            plan = json.loads(content)
            logger.info(f"–ü–ª–∞–Ω —É—Å–ø–µ—à–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω –≤ JSON —Ñ–æ—Ä–º–∞—Ç: {len(str(plan))} —Å–∏–º–≤–æ–ª–æ–≤")
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–µ–º–µ–Ω–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            plan["generated_at"] = datetime.now().isoformat()
            
            return plan
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫: {e}")
            raise

def format_training_plan(plan: Dict[str, Any]) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ø–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞
    
    Args:
        plan: –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–ª–∞–Ω–∞
        
    Returns:
        str: –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
    """
    output = []
    output.append("="*60)
    output.append(f"üèÉ –ü–õ–ê–ù –¢–†–ï–ù–ò–†–û–í–û–ö: {plan.get('plan_name', '–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω')}")
    output.append("="*60)
    output.append("")
    
    # –û–ø–∏—Å–∞–Ω–∏–µ –ø–ª–∞–Ω–∞
    output.append(plan.get('plan_description', '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'))
    output.append("")
    output.append(f"üìä –û–±—â–∏–π –æ–±—ä–µ–º: {plan.get('weekly_volume', '?')} –∫–º")
    output.append(f"üìà –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏: {plan.get('intensity_distribution', '?')}")
    output.append("")
    
    # –î–Ω–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
    output.append("üìÖ –†–ê–°–ü–ò–°–ê–ù–ò–ï –¢–†–ï–ù–ò–†–û–í–û–ö:")
    output.append("-"*60)
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–Ω–∏ –ø–æ –Ω–æ–º–µ—Ä—É
    all_days = []
    all_days.extend([{"type": "training", **day} for day in plan.get('training_days', [])])
    all_days.extend([{"type": "rest", **day} for day in plan.get('rest_days', [])])
    all_days.sort(key=lambda x: x.get('day', 0))
    
    for day_data in all_days:
        day_num = day_data.get('day', '?')
        day_name = day_data.get('day_of_week', '?')
        date = day_data.get('date', '')
        date_str = f" ({date})" if date else ""
        
        output.append(f"–î–ï–ù–¨ {day_num}: {day_name}{date_str}")
        
        if day_data.get('type') == 'training':
            workout_type = day_data.get('workout_type', '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞')
            distance = day_data.get('distance', '?')
            pace = day_data.get('pace', '?')
            hr = day_data.get('heart_rate', '?')
            
            output.append(f"üèÉ {workout_type} - {distance} –∫–º")
            output.append(f"‚è±Ô∏è –¢–µ–º–ø: {pace} –º–∏–Ω/–∫–º")
            output.append(f"‚ù§Ô∏è –ü—É–ª—å—Å: {hr}")
            output.append(f"üìù {day_data.get('description', '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è')}")
            output.append(f"üéØ –¶–µ–ª—å: {day_data.get('purpose', '–ù–µ —É–∫–∞–∑–∞–Ω–∞')}")
        else:
            activity = day_data.get('activity', '–û—Ç–¥—ã—Ö')
            output.append(f"üßò {activity}")
            output.append(f"üéØ –¶–µ–ª—å: {day_data.get('purpose', '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ')}")
        
        output.append("-"*60)
    
    # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    recommendations = plan.get('recommendations', {})
    if recommendations:
        output.append("üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:")
        for key, value in recommendations.items():
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–ª—é—á –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫
            title_map = {
                "nutrition": "–ü–∏—Ç–∞–Ω–∏–µ",
                "recovery": "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ",
                "progression": "–ü—Ä–æ–≥—Ä–µ—Å—Å–∏—è",
                "adjustments": "–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏"
            }
            title = title_map.get(key, key.capitalize())
            
            output.append(f"‚Ä¢ {title}: {value}")
        
        output.append("-"*60)
    
    return "\n".join(output)

def save_plan_to_file(plan: Dict[str, Any], filename: str = None) -> str:
    """
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ JSON —Ñ–∞–π–ª
    
    Args:
        plan: –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–ª–∞–Ω–∞
        filename: –ò–º—è —Ñ–∞–π–ª–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        
    Returns:
        str: –ü—É—Ç—å –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É
    """
    if not filename:
        filename = f"training_plan_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
    
    try:
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(plan, f, ensure_ascii=False, indent=2)
        
        logger.info(f"–ü–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª: {filename}")
        return filename
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–ª–∞–Ω–∞ –≤ —Ñ–∞–π–ª: {e}")
        raise

def test_coach_prompt():
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø–ª–∞–Ω–∞ —Å —Ç–µ—Å—Ç–æ–≤—ã–º –ø—Ä–æ—Ñ–∏–ª–µ–º
    """
    try:
        # –¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å –±–µ–≥—É–Ω–∞
        test_profile = {
            "distance": "10 –∫–º",
            "competition_date": "2025-07-15",
            "gender": "–ú—É–∂—Å–∫–æ–π",
            "age": 35,
            "height": 180,
            "weight": 75,
            "experience": "–õ—é–±–∏—Ç–µ–ª—å",
            "goal": "–£–ª—É—á—à–∏—Ç—å –≤—Ä–µ–º—è",
            "target_time": "50 –º–∏–Ω—É—Ç",
            "fitness_level": "–°—Ä–µ–¥–Ω–∏–π",
            "comfortable_pace": "5:30-6:30",
            "weekly_volume": 20,
            "training_days_per_week": 4
        }
        
        # –°–æ–∑–¥–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Ä–æ–º–ø—Ç–æ–≤ –∏ –ø–æ–ª—É—á–∞–µ–º –ø–ª–∞–Ω
        coach = CoachPrompt()
        plan = coach.generate_training_plan(test_profile)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–ª–∞–Ω –≤ —Ñ–∞–π–ª
        filename = save_plan_to_file(plan)
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏ –≤—ã–≤–æ–¥–∏–º –ø–ª–∞–Ω
        formatted_plan = format_training_plan(plan)
        print(formatted_plan)
        
        print(f"\n–ü–ª–∞–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª: {filename}")
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞: {e}")
        print(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
        return 1
        
    return 0

if __name__ == "__main__":
    sys.exit(test_coach_prompt())